---
// src/pages/b/[branch]/index.astro
export const prerender = true;

import Layout from "@/layouts/Base.astro";

// Генерируем список веток из предсобранных списков
export async function getStaticPaths() {
  const lists = import.meta.glob("/src/data/b/*/e/*/list.json", {
    eager: true,
    import: "default",
  }) as Record<string, any>;

  const branches = new Set<string>();
  for (const p of Object.keys(lists)) {
    const m = p.match(/^\/src\/data\/b\/([^/]+)\/e\/[^/]+\/list\.json$/);
    if (m) branches.add(m[1]);
  }
  return Array.from(branches).map((branch) => ({
    params: { branch },
    props: { branch },
  }));
}

const { branch } = Astro.props;

// Типы и их размеры в выбранной ветке
const lists = import.meta.glob("/src/data/b/*/e/*/list.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

const types = new Map<string, number>();
for (const [p, list] of Object.entries(lists)) {
  const m = p.match(/^\/src\/data\/b\/([^/]+)\/e\/([^/]+)\/list\.json$/);
  if (!m) continue;
  const [, b, type] = m;
  if (b !== branch) continue;
  types.set(type, Array.isArray(list) ? list.length : 0);
}
---

<Layout title={`Ветка · ${branch}`}>
  <h1>Ветка: {branch}</h1>
  {types.size ? (
    <ul>
      {Array.from(types.entries()).map(([t, n]) => (
        <li>
          <a href={`/b/${branch}/type/${t}/`}>{t}</a> <small>({n})</small>
        </li>
      ))}
    </ul>
  ) : (
    <p>Нет типов в ветке.</p>
  )}
</Layout>
