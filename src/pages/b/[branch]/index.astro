---
export const prerender = true;
import Layout from "@/layouts/Base.astro";

/** Собираем только ветки. Для каждой ветки отрендерим landing со списком доступных типов */
export async function getStaticPaths() {
  const lists = import.meta.glob("/src/data/b/*/e/*/list.json", {
    eager: true,
    import: "default",
  }) as Record<string, any>;

  const branches = new Set<string>();
  for (const p of Object.keys(lists)) {
    const m = p.match(/^\/src\/data\/b\/([^/]+)\/e\/[^/]+\/list\.json$/);
    if (m) branches.add(m[1]);
  }

  return Array.from(branches).map((branch) => ({ params: { branch }, props: { branch } }));
}

const { branch } = Astro.props;

/** Внутри страницы соберём список групп (types) для этой ветки */
const lists = import.meta.glob(`/src/data/b/${branch}/e/*/list.json`, {
  eager: true,
  import: "default",
}) as Record<string, any>;

const groups = Object.keys(lists).map((p) => {
  const m = p.match(/^\/src\/data\/b\/[^/]+\/e\/([^/]+)\/list\.json$/);
  const type = m?.[1] ?? "unknown";
  const arr = Array.isArray((lists[p] as any).default ?? lists[p]) ? (lists[p] as any).default ?? lists[p] : [];
  return { type, count: arr.length };
}).sort((a,b) => a.type.localeCompare(b.type));
---

<Layout title={`Ветка · ${branch}`}>
  <h1 style="margin:0 0 12px 0;">Ветка: {branch}</h1>

  {groups.length ? (
    <ul>
      {groups.map(({ type, count }) => (
        <li>
          <a href={`/b/${branch}/type/${type}/`}>{type} ({count})</a>
        </li>
      ))}
    </ul>
  ) : (
    <p>Нет данных для ветки {branch}.</p>
  )}
</Layout>
