---
export const prerender = true;

import Layout from "@/layouts/Base.astro";

// Собираем ветки/типы из предсобранных списков
export async function getStaticPaths() {
  const lists = import.meta.glob("/src/data/b/*/e/*/list.json", {
    eager: true,
    import: "default",
  }) as Record<string, any>;

  const seen = new Set<string>();
  const out: Array<{ params: { branch: string; type: string }, props: any }> = [];

  for (const p of Object.keys(lists)) {
    const m = p.match(/^\/src\/data\/b\/([^/]+)\/e\/([^/]+)\/list\.json$/);
    if (!m) continue;
    const [, branch, type] = m;
    const key = `${branch}/${type}`;
    if (seen.has(key)) continue;
    seen.add(key);

    // нормализуем элементы списка в {slug,title?}
    const arr = Array.isArray(lists[p]) ? lists[p] : [];
    const items = arr.map((it: any) =>
      typeof it === "string" ? { slug: it, title: it } : { slug: it.slug, title: it.title ?? it.slug }
    );

    out.push({ params: { branch, type }, props: { branch, type, items } });
  }
  return out;
}

const { branch, type, items } = Astro.props;
---

<Layout title={`${type} · ${branch}`}>
  <h1 style="margin:0 0 12px 0;">{type} · {branch}</h1>

  {items?.length ? (
    <ul>
      {items.map((it: any) => (
        <li>
          <a href={`/b/${branch}/e/${type}/${it.slug}/`}>{it.title}</a>
        </li>
      ))}
    </ul>
  ) : (
    <p>Нет сущностей.</p>
  )}
</Layout>
