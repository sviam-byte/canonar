---
export const prerender = true;

import Layout from "@/layouts/Base.astro";

export async function getStaticPaths() {
  // Собираем пары {branch,type} из мета-файлов
  const metas = import.meta.glob("/src/data/b/*/e/*/*.meta.json", {
    eager: true,
    import: "default",
  }) as Record<string, any>;

  const set = new Set<string>();
  for (const p of Object.keys(metas)) {
    const m = p.match(/^\/src\/data\/b\/([^/]+)\/e\/([^/]+)\/[^/]+\.meta\.json$/);
    if (!m) continue;
    const [, branch, type] = m;
    set.add(`${branch}__${type}`);
  }
  return Array.from(set).map((k) => {
    const [branch, type] = k.split("__");
    return { params: { branch, type } };
  });
}

const { branch, type } = Astro.params;

// Читаем предсобранный список именно здесь
const lists = import.meta.glob("/src/data/b/*/e/*/list.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

const key = `/src/data/b/${branch}/e/${type}/list.json`;
const list = (lists[key] ?? []) as Array<{ slug: string; title: string }>;
---

<Layout title={`${type} · ${branch}`}>
  <h1>{type} · {branch}</h1>
  {list?.length ? (
    <ul>
      {list.map((it) => (
        <li><a href={`/b/${branch}/e/${type}/${it.slug}/`}>{it.title}</a></li>
      ))}
    </ul>
  ) : (
    <p>Нет записей.</p>
  )}
</Layout>
