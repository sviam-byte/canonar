---
import Layout from "@/layouts/Base.astro";
import EntityPanel from "@/components/EntityPanel.tsx";
import { loadPaths } from "@/lib/paths";

// Эти JSON генерятся твоим скриптом; панель без них тоже отрендерим.
let meta: any = {};
let registry: any = {};
try {
  const mod = await import(`@/data/meta/${Astro.params.branch}/${Astro.params.type}/${Astro.params.slug}.json`, { assert: { type: "json" } } as any);
  meta = mod.default ?? mod;
} catch {/* fallback ok */}
try {
  const modR = await import("@/data/registry.json", { assert: { type: "json" } } as any);
  registry = modR.default ?? modR;
} catch {/* fallback ok */}

export async function getStaticPaths() {
  const entries = await loadPaths();
  return entries.map(({ branch, type, slug }) => ({
    params: { branch, type, slug },
    props: { branch, type, slug },
  }));
}
const { branch, type, slug } = Astro.params;
---

<Layout title={`CanonAR • ${meta?.title ?? slug}`}>
  <h2 style="margin:0 0 12px 0;">{meta?.title ?? meta?.name ?? slug}</h2>
  <EntityPanel
    branch={branch}
    viewType={type}
    type={type}
    meta={meta}
    registry={registry}
  />
</Layout>
