---
import Layout from "@/layouts/Base.astro";
import EntityPanel from "@/components/EntityPanel";

// Собираем все карточки из content/cards/<branch>/<type>/*.meta.json
export async function getStaticPaths() {
  // meta-файлы: /content/cards/current/characters/kaeya.meta.json и т.д.
  const metas = import.meta.glob("/content/cards/*/*/*.meta.json", { eager: true });

  // registry: /content/models/<branch>/registry.json
  const registries = import.meta.glob("/content/models/*/registry.json", { eager: true });

  const paths = [];
  for (const fullPath in metas) {
    // fullPath: "/content/cards/current/objects/coil-reactor.meta.json"
    const m = fullPath.match(/^\/content\/cards\/([^/]+)\/([^/]+)\/([^/.]+)\.meta\.json$/);
    if (!m) continue;
    const [, branch, type, slug] = m;

    const meta = (metas[fullPath] as any)?.default ?? (metas[fullPath] as any);
    const regKey = `/content/models/${branch}/registry.json`;
    const registry = (registries[regKey] as any)?.default ?? (registries[regKey] as any) ?? {};

    paths.push({
      params: { branch, type, slug },
      props: { branch, type, slug, meta, registry },
    });
  }

  return paths;
}

const { branch, type, slug, meta, registry } = Astro.props;
---

<Layout title={`${meta?.title ?? slug} — ${type}`}>
  <main style="max-width:1200px;margin:0 auto;padding:24px;">
    <h2 style="margin:0 0 12px 0;">Ветка: <code>{branch}</code> • Тип: <code>{type}</code> • Слаг: <code>{slug}</code></h2>

    <EntityPanel
      branch={branch}
      viewType={`${type}s`}
      meta={meta}
      registry={registry}
    />
  </main>
</Layout>
