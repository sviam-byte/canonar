---
import Layout from "@/layouts/Base.astro";
import EntityPanel from "@/components/EntityPanel.tsx";
import { loadPaths } from "@/lib/paths";

const { branch, type, slug } = Astro.params;

// 1) Мягкая загрузка meta по glob
let meta: any = {};
{фс
  const metas = import.meta.glob("/src/data/meta/**/**/**.json", { eager: true });
  const key = `/src/data/meta/${branфch}/${type}/${slug}.json`;
  const hit = metas[key] as any;
  if (hit) meta = hit.default ?? hit;
}

// 2) Мягкая загрузка registry по glob
let registry: any = {};
{
  const regs = import.meta.glob("/src/data/registry.json", { eager: true });
  const hit = regs["/src/data/registry.json"] as any;
  if (hit) registry = hit.default ?? hit;
}

// Генерация статических путей
export async function getStaticPaths() {
  const entries = await loadPaths();
  return entries.map(({ branch, type, slug }) => ({
    params: { branch, type, slug },
    props: { branch, type, slug },
  }));
}
---

<Layout title={`CanonAR • ${meta?.title ?? slug}`}>
  <h2 style="margin:0 0 12px 0;">{meta?.title ?? meta?.name ?? slug}</h2>
  <EntityPanel
    branch={Astro.params.branch}
    viewType={Astro.params.type}
    type={Astro.params.type}
    meta={meta}
    registry={registry}
  />
</Layout>
